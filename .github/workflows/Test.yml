name: Fetch & Parse Subscription with Sing-Box

on:
  workflow_dispatch:

jobs:
  fetch_parse_nodes:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Download latest Sing-Box Windows release
      - name: Download latest Sing-Box
        run: |
          echo Fetching latest Sing-Box release...
          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/SagerNet/sing-box/releases/latest"
          $asset = $release.assets | Where-Object { $_.name -match "windows-amd64.zip" } | Select-Object -First 1
          if (-not $asset) { Write-Error "No windows-amd64.zip found"; exit 1 }
          Invoke-WebRequest -Uri $asset.browser_download_url -OutFile sing-box.zip
          Expand-Archive sing-box.zip -DestinationPath sing-box

      # 3Ô∏è‚É£ Convert subscription to Sing-Box config
      - name: Convert subscription to Sing-Box config
        run: |
          echo Converting subscription to Sing-Box config...
          python -m pip install --upgrade pip
          pip install sing-box-subscribe
          sing-box-subscribe convert "${{ secrets.TEST_URL }}" -o config.json
          if (-Not (Test-Path config.json)) { Write-Error "config.json not created"; exit 1 }
          Get-Content config.json -TotalCount 5

      # 4Ô∏è‚É£ Parse config with Sing-Box
      - name: Parse config with Sing-Box
        run: |
          # Find the path to sing-box.exe inside extracted folder
          $exe = Get-ChildItem .\sing-box -Filter sing-box.exe -Recurse | Select-Object -First 1
          if (-not $exe) { Write-Error "sing-box.exe not found"; exit 1 }
          echo "Using Sing-Box executable: $($exe.FullName)"

          # Run Sing-Box with the generated config
          & $exe.FullName run -c config.json
          if (-Not (Test-Path nodes_checked.json)) { Write-Error "nodes_checked.json not created"; exit 1 }
          Get-Content nodes_checked.json -TotalCount 5

      # 5Ô∏è‚É£ Process parsed nodes into Test_Nodes.txt
      - name: Generate Test_Nodes.txt
        shell: pwsh
        run: |
          python <<'EOF'
          import json

          with open("nodes_checked.json", encoding="utf-8") as f:
              data = json.load(f)

          output_lines = []
          for idx, node in enumerate(data):
              raw = node.get("raw", "").strip()
              country_code = node.get("country_code", "XX")
              # Assign flag emoji
              if len(country_code) == 2:
                  flag = chr(0x1F1E6 + ord(country_code[0].upper()) - 65) + \
                         chr(0x1F1E6 + ord(country_code[1].upper()) - 65)
              else:
                  flag = "üè≥Ô∏è"
              new_name = f"{flag} {country_code}-{idx+1} | @Test"
              output_lines.append(f"{raw}#{new_name}")

          with open("Test_Nodes.txt", "w", encoding="utf-8") as f:
              f.write("\n".join(output_lines))

          print("‚úÖ Parsed nodes saved to Test_Nodes.txt")
          EOF
