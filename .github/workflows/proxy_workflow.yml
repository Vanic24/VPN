name: Proxy Configuration Automation

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Detect architecture
        id: arch
        run: |
          ARCH_RAW=$(uname -m)
          echo "Detected uname -m = ${ARCH_RAW}"
          if [[ "$ARCH_RAW" == "x86_64" ]]; then
            echo "ARCH=amd64" >> $GITHUB_ENV
          elif [[ "$ARCH_RAW" == "aarch64" || "$ARCH_RAW" == "arm64" ]]; then
            echo "ARCH=arm64" >> $GITHUB_ENV
          else
            echo "Unsupported architecture: $ARCH_RAW"
            exit 1
          fi

      - name: Prepare proxy cores
        run: |
          set -euo pipefail
          DOWNLOAD_DIR="$RUNNER_TEMP/proxy_cores"
          BIN_DIR="$DOWNLOAD_DIR/bin"
          mkdir -p "$DOWNLOAD_DIR" "$BIN_DIR"

          echo "ARCH is: ${ARCH:-not-set}"

          # ---------------- Download v2ray-core ----------------
          if [[ "${ARCH}" == "amd64" ]]; then
            V2RAY_URL="https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-64.zip"
          else
            V2RAY_URL="https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-arm64-v8a.zip"
          fi
          echo "Downloading v2ray-core from: $V2RAY_URL"
          curl -sSL --fail -o "$DOWNLOAD_DIR/v2ray.zip" "$V2RAY_URL"
          unzip -q -o "$DOWNLOAD_DIR/v2ray.zip" -d "$DOWNLOAD_DIR/v2ray_extracted"
          V2_BINARY=$(find "$DOWNLOAD_DIR/v2ray_extracted" -type f -name 'v2ray' -print -quit || true)
          if [[ -z "$V2_BINARY" ]]; then
            echo "v2ray binary not found in archive"
            exit 1
          fi
          cp "$V2_BINARY" "$BIN_DIR/v2ray"
          chmod +x "$BIN_DIR/v2ray"
          echo "v2ray installed to $BIN_DIR/v2ray"

          # ---------------- Download Mihomo (.gz binary) ----------------
          if [[ "${ARCH}" == "amd64" ]]; then
            MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/v1.19.13/mihomo-linux-amd64-v1.19.13.gz"
          else
            MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/v1.19.13/mihomo-linux-arm64-v1.19.13.gz"
          fi
          echo "Downloading Mihomo from: $MIHOMO_URL"
          curl -sSL --fail -o "$DOWNLOAD_DIR/mihomo.gz" "$MIHOMO_URL"
          gzip -t "$DOWNLOAD_DIR/mihomo.gz"
          gzip -dc "$DOWNLOAD_DIR/mihomo.gz" > "$BIN_DIR/mihomo"
          chmod +x "$BIN_DIR/mihomo"
          echo "mihomo installed to $BIN_DIR/mihomo"

          # ---------------- Download sing-box (tar.gz) ----------------
          if [[ "${ARCH}" == "amd64" ]]; then
            SINGBOX_URL="https://github.com/SagerNet/sing-box/releases/download/v1.12.4/sing-box-1.12.4-linux-amd64.tar.gz"
          else
            SINGBOX_URL="https://github.com/SagerNet/sing-box/releases/download/v1.12.4/sing-box-1.12.4-linux-arm64.tar.gz"
          fi
          echo "Downloading sing-box from: $SINGBOX_URL"
          curl -sSL --fail -o "$DOWNLOAD_DIR/sing-box.tar.gz" "$SINGBOX_URL"
          mkdir -p "$DOWNLOAD_DIR/singbox_extracted"
          tar -xzf "$DOWNLOAD_DIR/sing-box.tar.gz" -C "$DOWNLOAD_DIR/singbox_extracted" --strip-components=1
          SING_BINARY=$(find "$DOWNLOAD_DIR/singbox_extracted" -type f -name 'sing-box' -print -quit || true)
          if [[ -z "$SING_BINARY" ]]; then
            echo "sing-box binary not found after extraction"
            ls -la "$DOWNLOAD_DIR/singbox_extracted"
            exit 1
          fi
          cp "$SING_BINARY" "$BIN_DIR/sing-box"
          chmod +x "$BIN_DIR/sing-box"
          echo "sing-box installed to $BIN_DIR/sing-box"

          ls -la "$BIN_DIR"

      - name: Load SOURCES_TXT repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.SOURCES_TXT }}
          path: sources_repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Python generator script (via base64)
        run: |
          mkdir -p scripts
          # base64-decoded Python script to avoid heredoc/indentation issues in YAML
          echo "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwppbXBvcnQgb3MsIHN5cywgeWFtbCwgcmVxdWVzdHMKClNPVVJDRVNfRklMRSA9IG9zLmVu
          dmlyb25tZW50KQpUTVBMQVRFRl9GSUxFID0gImNsYXNoVGVtcGxhdGUueWFtbCIKVE9VUFVUX0ZJTEU9ICJDbGFzaC55YW1sIgoK
          cHJpbnQoIkxvYWRpbmcgc291cmNlcyBmcm9tOiIsIFNPVVJDRVNfRklMRSkKaWYgbm90IG9zLmlzZmlsZSg ... (truncated for brevity)" \
            | base64 -d > scripts/generate_clash.py
          chmod +x scripts/generate_clash.py

      - name: Run Python generator (generate Clash config)
        env:
          TEMPLATE_FILE: "ClashTemplate.yaml"
          OUTPUT_FILE: "Clash.yaml"
          SOURCES_FILE: "sources_repo/sources.txt"
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests
          python3 scripts/generate_clash.py

      - name: Commit and push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add Clash.yaml || true
          git commit -m "Auto update Clash config at $(date -u +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push || echo "Push failed"
