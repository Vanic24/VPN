name: Proxy Configuration Automation

on:
  schedule:
    - cron: '*/30 * * * *'  # Runs every 30 minutes
  workflow_dispatch:

jobs:
  generate_proxies_yaml:
    runs-on: ubuntu-latest
    env:
      CORE_TYPE: "mihomo"  # Change to "v2ray" or "sing-box" as needed
      SECRET_REPO: "SOURCES_TXT"
      TOKEN: ${{ secrets.GITHUB_TOKEN }}
      DOWNLOAD_DIR: "$RUNNER_TEMP/proxy_cores"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq bc unzip tar netcat-openbsd uuid-runtime

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Fetch sources.txt from secret repository
        run: |
          curl -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3.raw" \
            -o scripts/sources.txt \
            https://api.github.com/repos/$SECRET_REPO/contents/sources.txt

      - name: Download latest proxy core binaries with architecture detection
        run: |
          mkdir -p $DOWNLOAD_DIR
          ARCH=$(uname -m)
          echo "Detected architecture: $ARCH"

          # v2ray-core
          if [[ "$ARCH" == "x86_64" ]]; then
            V2RAY_URL="https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-64.zip"
          elif [[ "$ARCH" == "aarch64" ]]; then
            V2RAY_URL="https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-arm64-v8a.zip"
          else
            echo "Unsupported architecture: $ARCH"
            exit 1
          fi
          echo "Downloading v2ray-core from $V2RAY_URL ..."
          curl -L "$V2RAY_URL" -o $DOWNLOAD_DIR/v2ray.zip
          if unzip -tq $DOWNLOAD_DIR/v2ray.zip; then
            unzip -o $DOWNLOAD_DIR/v2ray.zip -d $DOWNLOAD_DIR/v2ray
            chmod +x $DOWNLOAD_DIR/v2ray/v2ray
          else
            echo "v2ray-core download failed or is not a valid ZIP file."
            exit 1
          fi

          # Mihomo - correct .gz binaries
          if [[ "$ARCH" == "x86_64" ]]; then
            MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/v1.19.13/mihomo-linux-amd64-v1.19.13.gz"
          elif [[ "$ARCH" == "aarch64" ]]; then
            MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/v1.19.13/mihomo-linux-arm64-v1.19.13.gz"
          else
            echo "Unsupported architecture: $ARCH"
            exit 1
          fi
          echo "Downloading Mihomo from $MIHOMO_URL ..."
          curl -L "$MIHOMO_URL" -o $DOWNLOAD_DIR/mihomo.gz
          if gzip -t $DOWNLOAD_DIR/mihomo.gz; then
            gzip -d $DOWNLOAD_DIR/mihomo.gz
            chmod +x $DOWNLOAD_DIR/mihomo
          else
            echo "Mihomo download failed or is not a valid GZ file."
            exit 1
          fi

          # sing-box - correct URLs and extraction
          if [[ "$ARCH" == "x86_64" ]]; then
            SINGBOX_URL="https://github.com/SagerNet/sing-box/releases/download/v1.12.4/sing-box-1.12.4-linux-amd64.tar.gz"
          elif [[ "$ARCH" == "aarch64" ]]; then
            SINGBOX_URL="https://github.com/SagerNet/sing-box/releases/download/v1.12.4/sing-box-1.12.4-linux-arm64.tar.gz"
          else
            echo "Unsupported architecture: $ARCH"
            exit 1
          fi
          echo "Downloading sing-box from $SINGBOX_URL ..."
          curl -L "$SINGBOX_URL" -o $DOWNLOAD_DIR/sing-box.tar.gz

          # Extract the binary
          mkdir -p $DOWNLOAD_DIR/sing-box
          tar -xzf $DOWNLOAD_DIR/sing-box.tar.gz -C $DOWNLOAD_DIR/sing-box --strip-components=1

          # Make sure binary exists
          if [ -f "$DOWNLOAD_DIR/sing-box/sing-box" ]; then
            chmod +x $DOWNLOAD_DIR/sing-box/sing-box
          else
            echo "sing-box binary not found after extraction!"
            exit 1
          fi

      - name: Parse and validate proxies
        run: |
          set -ex
          scripts/parse_and_validate_proxies.sh

      - name: Test proxy connectivity
        run: |
          set -ex
          scripts/test_proxy_connectivity.sh

      - name: Determine outlet IPs
        run: |
          set -ex
          CORE_BIN=""
          if [ "$CORE_TYPE" == "v2ray" ]; then CORE_BIN="$DOWNLOAD_DIR/v2ray/v2ray"; fi
          if [ "$CORE_TYPE" == "mihomo" ]; then CORE_BIN="$DOWNLOAD_DIR/mihomo"; fi
          if [ "$CORE_TYPE" == "sing-box" ]; then CORE_BIN="$DOWNLOAD_DIR/sing-box/sing-box"; fi
          export CORE_BIN
          scripts/determine_outlet_ips.sh

      - name: Format proxies into JSON
        run: |
          set -ex
          scripts/format_proxies.sh

      - name: Generate proxies.yaml for Clash
        run: |
          set -ex
          scripts/generate_proxies_yaml.sh

      - name: Commit and push proxies.yaml
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add proxies.yaml
          git commit -m "Update proxies.yaml" || echo "No changes to commit"
          git push || echo "Push failed or no changes"
