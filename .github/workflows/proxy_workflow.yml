name: Proxy Configuration Automation

on:
  schedule:
    - cron: '*/30 * * * *'  # Runs every 30 minutes
  workflow_dispatch:

jobs:
  generate_proxies_yaml:
    runs-on: ubuntu-latest
    env:
      CORE_TYPE: "mihomo"  # Change to "v2ray" or "sing-box" as needed
      SECRET_REPO: "YourUsername/SecretRepo"  # Replace with your secret repo
      TOKEN: ${{ secrets.GITHUB_TOKEN }}
      DOWNLOAD_DIR: "$RUNNER_TEMP/proxy_cores"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq bc unzip tar netcat-openbsd uuid-runtime

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Fetch sources.txt from secret repository
        run: |
          curl -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3.raw" \
            -o scripts/sources.txt \
            https://api.github.com/repos/$SECRET_REPO/contents/sources.txt

      - name: Download latest proxy core binaries dynamically
        run: |
          mkdir -p $DOWNLOAD_DIR
          ARCH=$(uname -m)
          echo "Detected architecture: $ARCH"

          # ---------------- Fetch latest release asset URLs dynamically ----------------
          MIHOMO_ASSET=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest)
          echo "Mihomo API response: $MIHOMO_ASSET"
          MIHOMO_ASSET_URL=$(echo "$MIHOMO_ASSET" | jq -r '.assets[] | select(.name | test("linux-amd64.*.gz$") or test("linux-arm64.*.gz$")) | .browser_download_url' | grep "$ARCH" | head -n 1)
          if [ -z "$MIHOMO_ASSET_URL" ]; then
            echo "Mihomo: No matching asset found for architecture $ARCH"
            exit 1
          fi
          echo "Mihomo download URL: $MIHOMO_ASSET_URL"

          V2RAY_ASSET=$(curl -s https://api.github.com/repos/v2fly/v2ray-core/releases/latest)
          echo "v2ray-core API response: $V2RAY_ASSET"
          V2RAY_ASSET_URL=$(echo "$V2RAY_ASSET" | jq -r '.assets[] | select(.name | test("linux-64.zip$") or test("linux-arm64-v8a.zip$")) | .browser_download_url' | grep "$ARCH" | head -n 1)
          if [ -z "$V2RAY_ASSET_URL" ]; then
            echo "v2ray-core: No matching asset found for architecture $ARCH"
            exit 1
          fi
          echo "v2ray-core download URL: $V2RAY_ASSET_URL"

          SINGBOX_ASSET=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest)
          echo "sing-box API response: $SINGBOX_ASSET"
          SINGBOX_ASSET_URL=$(echo "$SINGBOX_ASSET" | jq -r '.assets[] | select(.name | test("linux-amd64.tar.gz$") or test("linux-arm64.tar.gz$")) | .browser_download_url' | grep "$ARCH" | head -n 1)
          if [ -z "$SINGBOX_ASSET_URL" ]; then
            echo "sing-box: No matching asset found for architecture $ARCH"
            exit 1
          fi
          echo "sing-box download URL: $SINGBOX_ASSET_URL"

          # ---------------- Download and extract Mihomo ----------------
          curl -L "$MIHOMO_ASSET_URL" -o $DOWNLOAD_DIR/mihomo.gz
          if gzip -t $DOWNLOAD_DIR/mihomo.gz; then
            gzip -d $DOWNLOAD_DIR/mihomo.gz
            chmod +x $DOWNLOAD_DIR/mihomo
          else
            echo "Mihomo download failed or is not a valid GZ file."
            exit 1
          fi

          # ---------------- Download and extract v2ray-core ----------------
          curl -L "$V2RAY_ASSET_URL" -o $DOWNLOAD_DIR/v2ray.zip
          if unzip -tq $DOWNLOAD_DIR/v2ray.zip; then
            unzip -o $DOWNLOAD_DIR/v2ray.zip -d $DOWNLOAD_DIR/v2ray
            chmod +x $DOWNLOAD_DIR/v2ray/v2ray
          else
            echo "v2ray-core download failed or is not a valid ZIP file."
            exit 1
          fi

          # ---------------- Download and extract sing-box ----------------
          curl -L "$SINGBOX_ASSET_URL" -o $DOWNLOAD_DIR/sing-box.tar.gz
          if tar -tzf $DOWNLOAD_DIR/sing-box.tar.gz > /dev/null; then
            tar -xzf $DOWNLOAD_DIR/sing-box.tar.gz -C $DOWNLOAD_DIR
            chmod +x $DOWNLOAD_DIR/sing-box
          else
            echo "sing-box download failed or is not a valid TAR file."
            exit 1
          fi

      - name: Parse and validate proxies
        run: scripts/parse_and_validate_proxies.sh

      - name: Test proxy connectivity
        run: scripts/test_proxy_connectivity.sh

      - name: Determine outlet IPs
        run: |
          CORE_BIN=""
          if [ "$CORE_TYPE" == "v2ray" ]; then CORE_BIN="$DOWNLOAD_DIR/v2ray/v2ray"; fi
          if [ "$CORE_TYPE" == "mihomo" ]; then CORE_BIN="$DOWNLOAD_DIR/mihomo"; fi
          if [ "$CORE_TYPE" == "sing-box" ]; then CORE_BIN="$DOWNLOAD_DIR/sing-box"; fi
          export CORE_BIN
          scripts/determine_outlet_ips.sh

      - name: Format proxies into JSON
        run: scripts/format_proxies.sh

      - name: Generate proxies.yaml for Clash
        run: scripts/generate_proxies_yaml.sh

      - name: Commit and push proxies.yaml
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add proxies.yaml
          git commit -m "Update proxies.yaml"
          git push
