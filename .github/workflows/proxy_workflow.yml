name: Proxy Configuration Automation

on:
  schedule:
    - cron: '*/30 * * * *'  # Runs every 30 minutes
  workflow_dispatch:

jobs:
  generate_proxies_yaml:
    runs-on: ubuntu-latest
    env:
      CORE_TYPE: "mihomo"  # Change to "v2ray" or "sing-box" as needed
      SECRET_REPO: "YourUsername/SecretRepo"  # Replace with your secret repo
      TOKEN: ${{ secrets.GITHUB_TOKEN }}
      DOWNLOAD_DIR: "$RUNNER_TEMP/proxy_cores"
      PLATFORM: "x86_64"  # Change to "arm64" if needed

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq bc unzip tar netcat-openbsd uuid-runtime

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Fetch sources.txt from secret repository
        run: |
          curl -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3.raw" \
            -o scripts/sources.txt \
            https://api.github.com/repos/$SECRET_REPO/contents/sources.txt

      - name: Download latest proxy core binaries
        run: |
          mkdir -p $DOWNLOAD_DIR

          # Download v2ray-core
          curl -sSL https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-${PLATFORM}.zip -o $DOWNLOAD_DIR/v2ray.zip
          if unzip -tq $DOWNLOAD_DIR/v2ray.zip; then
            unzip -o $DOWNLOAD_DIR/v2ray.zip -d $DOWNLOAD_DIR/v2ray
            chmod +x $DOWNLOAD_DIR/v2ray/v2ray
          else
            echo "v2ray-core download failed or is not a valid ZIP file."
            exit 1
          fi

          # Download Mihomo (Clash.Meta)
          curl -sSL https://github.com/MetaCubeX/mihomo/releases/latest/download/mihomo-linux-${PLATFORM}.tar.gz -o $DOWNLOAD_DIR/mihomo.tar.gz
          if tar -tzf $DOWNLOAD_DIR/mihomo.tar.gz > /dev/null; then
            tar -xzf $DOWNLOAD_DIR/mihomo.tar.gz -C $DOWNLOAD_DIR
            chmod +x $DOWNLOAD_DIR/mihomo
          else
            echo "Mihomo download failed or is not a valid TAR file."
            exit 1
          fi

          # Download sing-box
          curl -sSL https://github.com/SagerNet/sing-box/releases/latest/download/sing-box-linux-${PLATFORM}.tar.gz -o $DOWNLOAD_DIR/sing-box.tar.gz
          if tar -tzf $DOWNLOAD_DIR/sing-box.tar.gz > /dev/null; then
            tar -xzf $DOWNLOAD_DIR/sing-box.tar.gz -C $DOWNLOAD_DIR
            chmod +x $DOWNLOAD_DIR/sing-box
          else
            echo "sing-box download failed or is not a valid TAR file."
            exit 1
          fi

      - name: Parse and validate proxies
        run: scripts/parse_and_validate_proxies.sh

      - name: Test proxy connectivity
        run: scripts/test_proxy_connectivity.sh

      - name: Determine outlet IPs
        run: |
          CORE_BIN=""
          if [ "$CORE_TYPE" == "v2ray" ]; then CORE_BIN="$DOWNLOAD_DIR/v2ray/v2ray"; fi
          if [ "$CORE_TYPE" == "mihomo" ]; then CORE_BIN="$DOWNLOAD_DIR/mihomo"; fi
          if [ "$CORE_TYPE" == "sing-box" ]; then CORE_BIN="$DOWNLOAD_DIR/sing-box"; fi
          export CORE_BIN
          scripts/determine_outlet_ips.sh

      - name: Format proxies into JSON
        run: scripts/format_proxies.sh

      - name: Generate proxies.yaml for Clash
        run: scripts/generate_proxies_yaml.sh

      - name: Commit and push proxies.yaml
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add proxies.yaml
          git commit -m "Update proxies.yaml"
          git push
