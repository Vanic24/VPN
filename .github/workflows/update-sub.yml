name: Update Clash Subscription

on:
  schedule:
    - cron: '0 */4 * * *' # every 4 hours
  workflow_dispatch:

jobs:
  update-subscription:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Set up Node.js (for potential JS-based config processing)
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Download latest subscription
        run: |
          curl -o ./clash_config.yaml "YOUR_SUBSCRIPTION_URL_HERE"

      - name: Merge User Config
        run: |
          # Replace or merge with your custom DNS, fake-IP, proxies, and rules
          cat << 'EOF' > ./merged_config.yaml
mixed-port: 7897
allow-lan: false
mode: rule
log-level: info
external-controller: '127.0.0.1:9097'
unified-delay: true
ipv6: true

profile:
  store-selected: true

tun:
  mtu: 1500

dns:
  enable: true
  ipv6: true
  use-system-hosts: false
  listen: '127.0.0.1:5335'
  default-nameserver: 
    - 180.76.76.76
    - 182.254.118.118
    - 8.8.8.8
    - 180.184.2.2
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  fake-ip-filter:
    - '*.lan'
    - 'stun.*.*.*'
    - 'stun.*.*'
    - 'time.windows.com'
    - 'time.nist.gov'
    - 'time.apple.com'
    - 'time.asia.apple.com'
    - '*.ntp.org.cn'
    - '*.openwrt.pool.ntp.org'
    - 'time1.cloud.tencent.com'
    - 'time.ustc.edu.cn'
    - 'pool.ntp.org'
    - 'ntp.ubuntu.com'
    - 'ntp.aliyun.com'
    - 'ntp1.aliyun.com'
    - 'ntp2.aliyun.com'
    - 'ntp3.aliyun.com'
    - 'ntp4.aliyun.com'
    - 'ntp5.aliyun.com'
    - 'ntp6.aliyun.com'
    - 'ntp7.aliyun.com'
    - '*.time.edu.cn'
    - 'time1.apple.com'
    - 'time2.apple.com'
    - 'time3.apple.com'
    - 'time4.apple.com'
    - 'time5.apple.com'
    - 'time6.apple.com'
    - 'time7.apple.com'
    - 'time1.google.com'
    - 'time2.google.com'
    - 'time3.google.com'
    - 'time4.google.com'
    - 'music.163.com'
    - '*.music.163.com'
    - '*.126.net'
    - 'musicapi.taihe.com'
    - 'music.taihe.com'
    - 'songsearch.kugou.com'
    - 'trackercdn.kugou.com'
    - '*.kuwo.cn'
    - 'api-jooxtt.sanook.com'
    - 'api.joox.com'
    - 'joox.com'
    - 'y.qq.com'
    - '*.y.qq.com'
    - 'streamoc.music.tc.qq.com'
    - 'mobileoc.music.tc.qq.com'
    - 'isure.stream.qqmusic.qq.com'
    - 'dl.stream.qqmusic.qq.com'
    - 'aqqmusic.tc.qq.com'
    - 'amobile.music.tc.qq.com'
    - '*.xiami.com'
    - '*.music.migu.cn'
    - 'music.migu.cn'
    - '*.msftconnecttest.com'
    - '*.msftncsi.com'
    - 'localhost.ptlogin2.qq.com'
    - '*.*.*.srv.nintendo.net'
    - '*.*.stun.playstation.net'
    - 'xbox.*.*.microsoft.com'
    - '*.ipv6.microsoft.com'
    - '*.*.xboxlive.com'
    - 'speedtest.cros.wr.pvp.net'
  nameserver:
    - 180.76.76.76
    - 119.29.29.29
    - 180.184.1.1
    - 223.5.5.5
    - 8.8.8.8
    - 'https://223.6.6.6/dns-query#h3=true'
    - 'https://dns.alidns.com/dns-query'
    - 'https://cloudflare-dns.com/dns-query'
    - 'https://doh.pub/dns-query'
  fallback-filter:
    geoip: true
    ipcidr:
      - 240.0.0.0/4
      - 0.0.0.0/32
      - 127.0.0.1/32
    domain:
      - '+.google.com'
      - '+.facebook.com'
      - '+.twitter.com'
      - '+.youtube.com'
      - '+.xn--ngstr-lra8j.com'
      - '+.google.cn'
      - '+.googleapis.cn'
      - '+.googleapis.com'
      - '+.gvt1.com'

proxies:
  # Replace with your real proxy entries
  - name: "Proxy1"
    type: ss
    server: x.x.x.x
    port: 443
    cipher: aes-128-gcm
    password: password
  - name: "Proxy2"
    type: ss
    server: y.y.y.y
    port: 443
    cipher: aes-128-gcm
    password: password

proxy-groups:
  - name: "选择线路"
    type: url-test
    proxies: [Proxy1, Proxy2]
    url: "http://www.gstatic.com/generate_204"
    interval: 300
  - name: "Proxy"
    type: select
    proxies: [Proxy1, Proxy2]

rules:
  # Include all your rules exactly as discussed
  - 'DOMAIN-SUFFIX,services.googleapis.cn,选择线路'
  - 'DOMAIN-SUFFIX,xn--ngstr-lra8j.com,选择线路'
  - 'DOMAIN,safebrowsing.urlsec.qq.com,DIRECT'
  - 'DOMAIN,safebrowsing.googleapis.com,DIRECT'
  - 'DOMAIN,developer.apple.com,选择线路'
  - 'DOMAIN-SUFFIX,digicert.com,选择线路'
  - 'DOMAIN,ocsp.apple.com,选择线路'
  - 'DOMAIN,ocsp.comodoca.com,选择线路'
  - 'DOMAIN,ocsp.usertrust.com,选择线路'
  - 'DOMAIN,ocsp.sectigo.com,选择线路'
  - 'DOMAIN,ocsp.verisign.net,选择线路'
  - 'DOMAIN-SUFFIX,apple-dns.net,选择线路'
  - 'DOMAIN,testflight.apple.com,选择线路'
  - 'DOMAIN,sandbox.itunes.apple.com,选择线路'
  - 'DOMAIN,itunes.apple.com,选择线路'
  - 'DOMAIN-SUFFIX,apps.apple.com,选择线路'
  - 'DOMAIN-SUFFIX,blobstore.apple.com,选择线路'
  - 'DOMAIN,cvws.icloud-content.com,选择线路'
  - 'DOMAIN-SUFFIX,mzstatic.com,DIRECT'
  - 'DOMAIN-SUFFIX,itunes.apple.com,DIRECT'
  - 'DOMAIN-SUFFIX,icloud.com,DIRECT'
  - 'DOMAIN-SUFFIX,icloud-content.com,DIRECT'
  - 'DOMAIN-SUFFIX,me.com,DIRECT'
  - 'DOMAIN-SUFFIX,aaplimg.com,DIRECT'
  - 'DOMAIN-SUFFIX,cdn20.com,DIRECT'
  - 'DOMAIN-SUFFIX,cdn-apple.com,DIRECT'
  - 'DOMAIN-SUFFIX,akadns.net,DIRECT'
  - 'DOMAIN-SUFFIX,akamaiedge.net,DIRECT'
  - 'DOMAIN-SUFFIX,edgekey.net,DIRECT'
  - 'DOMAIN-SUFFIX,mwcloudcdn.com,DIRECT'
  - 'DOMAIN-SUFFIX,mwcname.com,DIRECT'
  - 'DOMAIN-SUFFIX,apple.com,DIRECT'
  - 'DOMAIN-SUFFIX,apple-cloudkit.com,DIRECT'
  - 'DOMAIN-SUFFIX,apple-mapkit.com,DIRECT'
  - 'DOMAIN-SUFFIX,126.com,DIRECT'
  - 'DOMAIN-SUFFIX,126.net,DIRECT'
  - 'DOMAIN-SUFFIX,127.net,DIRECT'
  - 'DOMAIN-SUFFIX,163.com,DIRECT'
  - 'DOMAIN-SUFFIX,360buyimg.com,DIRECT'
  - 'DOMAIN-SUFFIX,36kr.com,DIRECT'
  - 'DOMAIN-SUFFIX,acfun.tv,DIRECT'
  - 'DOMAIN-SUFFIX,air-matters.com,DIRECT'
  - 'DOMAIN-SUFFIX,aixifan.com,DIRECT'
  - 'DOMAIN-KEYWORD,alicdn,DIRECT'
  - 'DOMAIN-KEYWORD,alipay,DIRECT'
  - 'DOMAIN-KEYWORD,taobao,DIRECT'
  # ... add the rest of your rules here ...

EOF

      - name: Commit updated config
        run: |
          git config user.name "Vanic24"
          git config user.email "apple.pine@inbox.ru"
          git add ./merged_config.yaml
          git commit -m "Auto update Clash config"
          git push
